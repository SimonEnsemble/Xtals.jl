image: julia:1.6  # Docker img of a system w/ Julia 1.6


# # # STAGES

# build stages execute sequentially; jobs within a stage execute parallel to one another
# every job is run on a new VM
stages:
  - build # wherein we check that the minimum build succeeds
  - test # wherein the full build is unit/doc/cross tested in parallel
  - deploy # wherein we build and deploy the documentation


# # # BUILD STAGE

minimal-build: # test minimal build, no Python
  stage: build
  script:
    - julia --project=@. -e 'import Pkg; Pkg.build("Xtals"); using Xtals'

## TODO cron job to check that registered version loads

# all jobs in next stage of pipeline need the things installed by quick_setup.jl
full-build: # full build for complete testing
  stage: build
  script:
    - julia --project=@. quick_setup.jl
  artifacts:
    paths:
      - ~/.julia/*


# # # TEST STAGE

artifact-testing: # check that previous build state has been preserved
  stage: test
  script:
    - julia --project=@. ./test/unit_tests.jl

unit-testing: # run all the unit tests
  stage: test
  before_script:
    - julia --project=@. quick_setup.jl
  script:
    - julia --project=@. ./test/unit_tests.jl

docs-code-testing: # test the code examples in the docs
  stage: test
  before_script:
    - julia --project=@. -e 'using Xtals'
    - julia --project=@. quick_setup.jl
  script:
    - julia --project=@. ./test/doc_tests.jl

porousmaterials-testing: # check for breaking changes
  stage: test
  before_script:
    - julia --project=@. quick_setup.jl
  script:
    - julia --project=@. ./test/cross_dep.jl PorousMaterials

porematmod-testing: # check for breaking changes
  stage: test
  before_script:
    - julia --project=@. quick_setup.jl
  script:
    - julia --project=@. ./test/cross_dep.jl PoreMatMod


# # # DEPLOY STAGE

deploy-docs: # build and deploy the docs
  stage: deploy
  before_script:
    - julia --project=@. -e 'import Pkg; Pkg.add("Documenter")'
  script:
    - julia --project=@. ./docs/make.jl
